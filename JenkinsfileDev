#!groovy

pipeline {
    agent {                                                             
        label 'localAgent'
    }
    environment {
        SF_USERNAME_DEV = 'jenkins1@silverlinecrm.com.zendev'
        PRIVATE_KEY = credentials('SERVER_KEY_ID')
        CLIENT_ID_DEV = credentials('SF_CLIENT_ID_SRC')
        SF_LOGIN_DEV = 'https://login.salesforce.com'
        SF_DEV_PSW = credentials('SF_LOGIN_SRC_PSW')
        TEST_LEVEL = 'RunLocalTests'
        PACKAGE_NAME = '0Ho8c0000004CILCA2'
        PACKAGE_VERSION = '0.0.0'
    }
    options {
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '5'))
        skipDefaultCheckout()
        timeout(time: 15, unit: 'MINUTES')
    }
    stages {                                                           
        stage('Print Environment') {
            steps {
              
                 echo "Checking environment"
                 sh """
                 whoami
                 pwd
                 uname -a
                 ls
                 sfdx version
                 """
            }
        }
        stage('checkout source') {
             steps {
            checkout scm
             sh 'tree'
             }
        }   
        stage('Authorize DevHub') {
           
            steps {
                sh 'sfdx auth:jwt:grant -u ${SF_USERNAME_DEV} -f ${PRIVATE_KEY} -i ${CLIENT_ID_DEV} -r https://login.salesforce.com -a devHub'
                sh 'sfdx force:org:display -u ${SF_USERNAME_DEV}'
                echo "Checking out repository..."
                checkout scm
               
                echo "done! ..."
             
            }
        }

        stage('Create Test Scratch Org') {
             steps {
            sh  "sfdx force:org:create --targetdevhubusername devHub --setdefaultusername --definitionfile config/project-scratch-def.json --setalias ciorgDEV --wait 10 --durationdays 1"
            sh "sfdx force:org:display --targetusername ciorgDEV"
             }
        }

        stage('Push To Test Scratch Org') {
             steps {
                sh "sfdx force:source:push --targetusername ciorgDEV"
             }
                
        }

        stage('Run Tests In Test Scratch Org') {
             steps {
                sh  "sfdx force:apex:test:run --targetusername ciorgDEV --wait 10 --resultformat tap --codecoverage --testlevel ${TEST_LEVEL}"
             }
              
            }


            

            // -------------------------------------------------------------------------
            // Delete test scratch org.
            // -------------------------------------------------------------------------

            stage('Delete Test Scratch Org') {
                 steps {
                sh "sfdx force:org:delete --targetusername ciorgDEV --noprompt"
                 }
    
            }


       
    }
    post {
        always {
            echo 'cleaning up the workspace after build.....'
            deleteDir()
            sh 'echo "###DONE!!"'
            
        }
      
    }
}
